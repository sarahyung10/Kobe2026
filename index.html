<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>神戶親子慢旅 2026 (雲端版)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <style>
        :root { --jp-header: #5d6b5b; --jp-bg: #f4f3ef; --jp-text: #595959; --jp-accent: #b86e6e; }
        body { background-color: #e0ded8; color: var(--jp-text); font-family: "Zen Maru Gothic", sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; } .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #app-container { max-width: 480px; margin: 0 auto; background-color: var(--jp-bg); height: 100vh; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        #map { width: 100%; height: 100%; z-index: 1; background: #e8e6df; }
        .custom-checkbox:checked { background-color: var(--jp-accent); border-color: var(--jp-accent); }
        .cat-btn-active { background-color: var(--jp-header); color: white; border-color: var(--jp-header); transform: scale(1.05); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .pay-btn-active { background-color: white; color: var(--jp-header); font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .weather-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .timeline-line { z-index: 0; }
        .timeline-line::before { content: ''; position: absolute; top: 24px; bottom: -20px; left: 24px; width: 2px; background-image: linear-gradient(to bottom, #d1d5db 50%, transparent 50%); background-size: 2px 10px; z-index: -1; }
        .last-item .timeline-line::before { display: none; }
        .plane-anim { animation: fly 3s linear infinite; }
        @keyframes fly { 0% { transform: translateX(-100%); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateX(100%); opacity: 0; } }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .loading-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="app">
    <div id="app-container">
        
        <div v-if="isLoading" class="loading-overlay">
            <i class="fa-solid fa-cloud-arrow-down text-4xl text-[#5d6b5b] mb-4 animate-bounce"></i>
            <p class="text-sm font-bold text-gray-500">正在連接資料庫...</p>
            <p class="text-xs text-gray-400 mt-2">v27 頂部導覽版</p>
            <button v-if="showSkipButton" @click="forceEnter" class="mt-6 border border-gray-300 px-4 py-2 rounded-full text-xs text-gray-400 hover:bg-gray-50">
                連線逾時？點此離線進入
            </button>
        </div>

        <header class="bg-[#5d6b5b] px-6 pt-10 pb-6 shadow-md z-30 shrink-0 text-white relative overflow-hidden">
            <div class="absolute -right-10 -top-10 w-48 h-48 bg-white/10 rounded-full blur-3xl"></div>
            <div class="flex justify-between items-center relative z-10">
                <div>
                    <h1 class="text-3xl font-black tracking-widest text-white drop-shadow-md mb-1">KOBE <span class="text-[10px] bg-green-400 text-green-900 px-1.5 rounded ml-1 align-middle">ONLINE</span></h1>
                    <div class="flex items-center gap-2">
                         <span class="text-[10px] bg-[#b86e6e] px-2 py-0.5 rounded text-white font-bold tracking-wider shadow-sm">2026</span>
                         <span class="text-sm font-bold text-gray-100 tracking-wider">{{ getDayLabel(selectedDate) }}</span>
                    </div>
                </div>
                <div class="text-right flex flex-col items-end weather-shadow min-h-[50px] justify-center">
                    <transition name="fade">
                        <div v-if="currentWeather">
                            <div class="text-4xl mb-1 filter drop-shadow-lg"><i :class="getWeatherIcon(currentWeather.code)"></i></div>
                            <div class="text-lg font-bold leading-none">{{ currentWeather.min }}° <span class="text-white/60 text-sm mx-0.5">/</span> {{ currentWeather.max }}°</div>
                        </div>
                    </transition>
                </div>
            </div>
        </header>

        <nav class="bg-white border-b border-gray-100 flex justify-around items-center px-2 py-3 shrink-0 z-20 shadow-sm relative">
            <button @click="switchTab('checklist')" :class="['flex flex-col items-center gap-1.5 w-1/4 transition-colors', currentTab === 'checklist' ? 'text-[#b86e6e]' : 'text-gray-300']"><i class="fa-solid fa-check-double text-xl"></i><span class="text-[10px] font-bold tracking-wide">清單</span></button>
            <button @click="switchTab('money')" :class="['flex flex-col items-center gap-1.5 w-1/4 transition-colors', currentTab === 'money' ? 'text-[#b86e6e]' : 'text-gray-300']"><i class="fa-solid fa-wallet text-xl"></i><span class="text-[10px] font-bold tracking-wide">記帳</span></button>
            <button @click="switchTab('schedule')" :class="['flex flex-col items-center gap-1.5 w-1/4 transition-colors', currentTab === 'schedule' ? 'text-[#b86e6e]' : 'text-gray-300']"><i class="fa-solid fa-list-ul text-xl"></i><span class="text-[10px] font-bold tracking-wide">行程</span></button>
            <button @click="switchTab('map')" :class="['flex flex-col items-center gap-1.5 w-1/4 transition-colors', currentTab === 'map' ? 'text-[#b86e6e]' : 'text-gray-300']"><i class="fa-regular fa-map text-xl"></i><span class="text-[10px] font-bold tracking-wide">地圖</span></button>
        </nav>

        <main class="flex-1 overflow-hidden relative">
            
            <div v-show="currentTab === 'checklist'" class="h-full overflow-y-auto no-scrollbar px-5 pt-6 pb-32">
                <div class="bg-white p-6 rounded-[1.5rem] shadow-sm mb-4">
                    <h3 class="text-base font-bold text-gray-700 mb-4 flex items-center"><i class="fa-solid fa-clipboard-check mr-2 text-[#5d6b5b]"></i> 待辦清單</h3>
                    <div class="flex gap-2 mb-6">
                        <input type="text" v-model="newCheckItem" placeholder="新增項目..." class="flex-1 bg-gray-50 border-none rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-[#5d6b5b]" @keyup.enter="addCheckItem">
                        <button @click="addCheckItem" class="bg-[#5d6b5b] text-white px-4 py-2 rounded-xl text-sm font-bold shadow-md active:scale-95 transition-transform"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <div class="space-y-2">
                        <div v-for="item in checklistItems" :key="item.id" class="flex items-center justify-between p-3 border border-gray-100 rounded-xl hover:bg-gray-50 transition-colors group">
                            <div class="flex items-center">
                                <input type="checkbox" v-model="item.checked" @change="syncToCloud" class="w-5 h-5 rounded-md border-gray-300 text-[#b86e6e] focus:ring-[#b86e6e] custom-checkbox transition-all cursor-pointer">
                            </div>
                            <div v-if="editingCheckItemId === item.id" class="flex-1 ml-3">
                                <input :id="'check-input-' + item.id" type="text" v-model="editingCheckItemText" @blur="saveCheckItem" @keyup.enter="saveCheckItem" class="w-full bg-white border-2 border-[#5d6b5b] rounded px-2 py-1 text-sm outline-none shadow-sm text-gray-700 font-bold">
                            </div>
                            <div v-else @click="editCheckItem(item)" class="flex-1 ml-3 cursor-text py-1">
                                <span :class="['text-sm font-medium transition-all block', item.checked ? 'text-gray-300 line-through' : 'text-gray-700']">{{ item.text }}</span>
                            </div>
                            <button @click="deleteCheckItem(item.id)" class="text-gray-300 hover:text-red-400 p-2 opacity-0 group-hover:opacity-100 transition-opacity ml-2"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'money'" class="h-full overflow-y-auto no-scrollbar px-5 pt-6 pb-32">
                <div class="flex justify-between items-center mb-4 px-2">
                    <span class="text-xs font-bold text-gray-400">當前匯率</span>
                    <button @click="fetchRate" class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-full shadow-sm text-xs font-bold text-[#5d6b5b] active:scale-95 transition-transform border border-gray-100"><i class="fa-solid fa-rotate text-[10px]"></i> 1 JPY ≈ {{ exchangeRate.toFixed(3) }}</button>
                </div>
                <div class="bg-[#5d6b5b] text-white rounded-[2rem] p-6 shadow-xl shadow-[#5d6b5b]/20 mb-6 relative overflow-hidden">
                    <div class="absolute right-0 top-0 w-40 h-40 bg-white/10 rounded-full blur-3xl transform translate-x-10 -translate-y-10"></div>
                    <div class="mb-5 relative z-10">
                        <p class="text-xs text-gray-300 mb-1 tracking-widest font-medium">總支出 TOTAL</p>
                        <div class="flex items-baseline gap-2"><span class="text-4xl font-black font-mono tracking-tight">¥{{ formatNumber(totalExpense) }}</span></div>
                        <p class="text-xs text-gray-300 mt-1">折合台幣約 NT$ {{ formatNumber(Math.round(totalTWD)) }}</p>
                    </div>
                    <div class="h-px bg-white/20 w-full mb-4"></div>
                    <div class="relative z-10">
                        <div class="flex justify-between items-end mb-2">
                            <div>
                                <p class="text-[10px] text-gray-300 font-bold mb-1 flex items-center gap-1"><i class="fa-solid fa-wallet"></i> 現金預算</p>
                                <div class="flex items-center gap-1"><span class="text-xs">¥</span><input type="number" inputmode="numeric" v-model="cashBudget" @change="syncToCloud" class="bg-transparent border-b border-white/30 text-white font-bold w-24 focus:outline-none focus:border-white font-mono text-sm"></div>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] text-gray-300 mb-0.5">剩餘現金</p>
                                <p :class="['text-xl font-bold font-mono', remainingCash < cashBudget * 0.1 ? 'text-[#ffadad]' : 'text-white']">¥{{ formatNumber(remainingCash) }}</p>
                            </div>
                        </div>
                        <div class="w-full h-1.5 bg-black/20 rounded-full overflow-hidden">
                            <div class="h-full bg-[#b86e6e] rounded-full transition-all duration-500" :style="{ width: Math.max(0, Math.min(100, (remainingCash / cashBudget) * 100)) + '%' }"></div>
                        </div>
                    </div>
                </div>
                 <div class="space-y-6">
                     <div v-if="groupedExpenses.length === 0" class="p-10 text-center text-gray-300 text-sm bg-white rounded-[1.5rem] border border-gray-100">尚未記帳，錢包滿滿！</div>
                     <div v-for="group in groupedExpenses" :key="group.date" class="animate-up">
                         <div class="flex items-center justify-between px-3 mb-2">
                             <h3 class="text-sm font-bold text-[#5d6b5b] flex items-center gap-2"><i class="fa-regular fa-calendar text-[#b86e6e]"></i> {{ group.label }}</h3>
                             <span class="text-xs font-bold text-gray-400 bg-white px-2 py-0.5 rounded-md shadow-sm border border-gray-100">日計: ¥{{ formatNumber(group.subtotal) }}</span>
                         </div>
                         <div class="bg-white rounded-[1.5rem] shadow-sm overflow-hidden border border-gray-100">
                             <ul class="divide-y divide-gray-50">
                                <li v-for="exp in group.items" :key="exp.id" class="p-4 flex justify-between items-center hover:bg-gray-50 transition-colors">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 rounded-full bg-[#f4f3ef] flex items-center justify-center text-[#5d6b5b] text-lg shrink-0"><i :class="getCategoryIcon(exp.category)"></i></div>
                                        <div>
                                            <p class="text-sm font-bold text-gray-700">{{ exp.item }}</p>
                                            <div class="flex items-center gap-2 mt-0.5">
                                                <span :class="['text-[9px] px-1.5 py-0.5 rounded font-bold border', exp.method === 'card' ? 'bg-blue-50 text-blue-600 border-blue-100' : 'bg-green-50 text-green-600 border-green-100']">{{ exp.method === 'card' ? '刷卡' : '現金' }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-right whitespace-nowrap">
                                        <p class="text-base font-bold text-[#5d6b5b] font-mono">¥{{ formatNumber(exp.amount) }}</p>
                                        <p class="text-[10px] text-gray-400 font-mono">≈ ${{ formatNumber(Math.round(exp.amount * (exp.fixedRate || exchangeRate))) }}</p>
                                    </div>
                                    <button @click="deleteExpense(exp.id)" class="ml-1 text-xs text-red-300 hover:text-red-500 font-medium p-2"><i class="fa-solid fa-trash-can"></i></button>
                                </li>
                            </ul>
                         </div>
                     </div>
                 </div>
                 <div class="h-8"></div>
            </div>

            <div v-show="currentTab === 'schedule'" class="h-full overflow-y-auto no-scrollbar px-5 pt-6 pb-32">
                <div v-if="currentFlight" class="mb-6 bg-[#2d2d2d] rounded-2xl p-6 shadow-xl text-white relative overflow-hidden border-t-4" :style="{ borderColor: currentFlight.colorCode || '#b86e6e' }">
                    <div class="absolute right-0 top-0 w-32 h-32 bg-white/5 rounded-full blur-2xl"></div>
                    <div class="flex justify-between items-start mb-6 relative z-10">
                        <div class="flex items-center gap-2">
                            <span :class="['text-[10px] font-bold px-2 py-0.5 rounded text-white', currentFlight.colorClass || 'bg-[#b86e6e]']">{{ currentFlight.airline }}</span>
                            <span class="text-lg font-black tracking-widest">{{ currentFlight.number }}</span>
                        </div>
                        <div class="text-right">
                            <span :class="['text-xs px-2 py-1 rounded font-bold flex items-center gap-1.5', currentFlightStatus.includes('準點') ? 'bg-green-900/50 text-green-300' : 'bg-blue-900/50 text-blue-300']">
                                <span class="w-1.5 h-1.5 rounded-full" :class="currentFlightStatus.includes('準點') ? 'bg-green-400' : 'bg-blue-400'"></span>
                                {{ currentFlightStatus }}
                            </span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center px-1 mb-6 relative z-10">
                        <div class="text-center">
                            <p class="text-4xl font-black text-white leading-none tracking-tight">{{ currentFlight.depTime }}</p>
                            <p class="text-sm font-bold mt-1 tracking-wider" :style="{ color: currentFlight.colorCode || '#b86e6e' }">{{ currentFlight.depCode }}</p>
                        </div>
                        <div class="flex-1 flex flex-col items-center px-4">
                            <p class="text-[10px] text-gray-400 mb-1 font-mono">{{ currentFlight.duration }}</p>
                            <div class="w-full h-px bg-white/20 relative">
                                <div class="absolute top-1/2 -translate-y-1/2 left-0 w-full h-full overflow-hidden">
                                     <i class="fa-solid fa-plane text-white/60 text-xs plane-anim absolute"></i>
                                </div>
                            </div>
                        </div>
                        <div class="text-center">
                            <p class="text-4xl font-black text-white leading-none tracking-tight">{{ currentFlight.arrTime }}</p>
                            <p class="text-sm font-bold mt-1 tracking-wider" :style="{ color: currentFlight.colorCode || '#b86e6e' }">{{ currentFlight.arrCode }}</p>
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-4 border-t border-white/10 relative z-10">
                        <span class="text-xs text-gray-400">{{ currentFlight.date }}</span>
                        <a :href="currentFlight.link" target="_blank" class="text-xs text-white bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-full font-bold transition-colors flex items-center gap-1">
                            即時追蹤 <i class="fa-solid fa-arrow-right text-[10px]"></i>
                        </a>
                    </div>
                </div>

                <div class="flex overflow-x-auto gap-3 pb-6 no-scrollbar mb-2 sticky top-0 bg-[#f4f3ef] z-50 pt-1 transition-colors">
                    <button v-for="date in dates" :key="date.key" @click="selectedDate = date.key"
                        :class="['flex-shrink-0 px-5 py-2.5 rounded-2xl text-sm font-bold transition-all shadow-sm border-2', 
                                 selectedDate === date.key ? 'bg-[#5d6b5b] text-white border-[#5d6b5b] shadow-lg transform scale-100' : 'bg-white text-gray-400 border-transparent hover:bg-gray-50']">
                        {{ date.label }}
                    </button>
                </div>

                <div class="space-y-0 relative z-0">
                    <div v-if="currentDateItinerary.length === 0" class="text-center py-16 text-gray-400 text-sm flex flex-col items-center">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-3"><i class="fa-regular fa-calendar-xmark text-2xl text-gray-300"></i></div>
                        <p>本日行程空白<br>按 + 開始規劃</p>
                    </div>
                    
                    <div v-for="(item, index) in currentDateItinerary" :key="item.id" 
                         :class="['relative pl-14 pb-10 timeline-line', index === currentDateItinerary.length - 1 ? 'last-item' : '']">
                        <div class="absolute left-[18px] top-[14px] w-3.5 h-3.5 rounded-full bg-[#b86e6e] border-2 border-[#f4f3ef] z-10 shadow-sm ring-2 ring-[#b86e6e]/20"></div>
                        <div class="group pt-2">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="font-mono text-lg font-black text-[#5d6b5b] tracking-tighter bg-[#5d6b5b]/10 px-2 rounded-md">{{ item.time }}</span>
                            </div>
                            <div class="bg-white p-5 rounded-[1.2rem] shadow-[0_8px_20px_-6px_rgba(0,0,0,0.05)] border border-gray-100 relative transition-transform active:scale-[0.99]">
                                <h3 class="text-lg font-bold text-gray-800 mb-1 leading-snug">{{ item.title }}</h3>
                                <a v-if="item.location" :href="'http://googleusercontent.com/maps.google.com/6' + encodeURIComponent(item.location)" target="_blank"
                                   class="inline-flex items-center gap-1.5 text-xs font-bold text-[#b86e6e] hover:bg-[#b86e6e]/10 px-2 py-1 rounded-lg -ml-2 transition-colors"><i class="fa-solid fa-location-dot"></i> {{ item.location }}</a>
                                <div v-if="item.notes" class="mt-3 text-sm text-gray-600 bg-[#f9f9f7] p-3 rounded-xl leading-relaxed whitespace-pre-line border-l-2 border-[#dcdcdc]">{{ item.notes }}</div>
                                <div class="absolute top-4 right-4 flex gap-3 opacity-30 group-hover:opacity-100 transition-opacity">
                                    <button @click="editItinerary(item)" class="text-gray-400 hover:text-[#5d6b5b]"><i class="fa-solid fa-pen"></i></button>
                                    <button @click="deleteItinerary(item.id)" class="text-gray-400 hover:text-red-400"><i class="fa-solid fa-trash-can"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'map'" class="h-full w-full relative flex flex-col">
                 <div class="bg-[#f4f3ef] z-10 pt-2 pb-2 shadow-sm">
                     <div class="flex overflow-x-auto gap-3 px-4 no-scrollbar">
                        <button v-for="date in dates" :key="date.key" @click="selectedDate = date.key"
                            :class="['flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold transition-all border', selectedDate === date.key ? 'bg-[#5d6b5b] text-white border-[#5d6b5b] shadow-md' : 'bg-white text-gray-500 border-gray-200']">{{ date.label }}</button>
                     </div>
                 </div>
                 <div class="flex-1 relative"><div id="map" class="absolute inset-0 w-full h-full"></div></div>
            </div>

        </main>

        <button v-if="currentTab === 'schedule' || currentTab === 'money'" @click="openAddModal" class="absolute bottom-8 right-5 w-16 h-16 bg-[#5d6b5b] text-white rounded-full shadow-2xl shadow-[#5d6b5b]/40 flex items-center justify-center text-2xl z-30 transition-all active:scale-90 hover:scale-105 border-4 border-[#f4f3ef]"><i class="fa-solid fa-plus"></i></button>

        <div v-if="showModal" class="absolute inset-0 z-50 bg-[#464646]/60 backdrop-blur-[4px] flex items-end sm:items-center justify-center" @click.self="showModal = false">
            <div class="bg-white w-full sm:w-[90%] rounded-t-[2rem] sm:rounded-[2rem] p-7 shadow-2xl pb-10 animate-up">
                <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
                <h3 class="text-xl font-black text-[#5d6b5b] mb-6 text-center tracking-wide">{{ currentTab === 'money' ? '記上一筆' : (editingId ? '編輯行程' : '新增行程') }}</h3>
                <div v-if="currentTab !== 'money'" class="space-y-4">
                    <select v-model="newItem.dateKey" class="w-full bg-[#f4f3ef] border-none rounded-2xl p-4 text-sm font-bold text-gray-700 outline-none focus:ring-2 focus:ring-[#5d6b5b]"><option v-for="date in dates" :value="date.key">{{ date.label }}</option></select>
                    <div class="flex gap-3">
                        <input type="time" v-model="newItem.time" class="w-1/3 bg-[#f4f3ef] border-none rounded-2xl p-4 text-sm text-center outline-none focus:ring-2 focus:ring-[#5d6b5b] font-mono font-bold">
                        <input type="text" v-model="newItem.title" placeholder="標題" class="w-2/3 bg-[#f4f3ef] border-none rounded-2xl p-4 text-sm font-bold outline-none focus:ring-2 focus:ring-[#5d6b5b]">
                    </div>
                    <input type="text" v-model="newItem.location" placeholder="地點 (地圖搜尋用)" class="w-full bg-[#f4f3ef] border-none rounded-2xl p-4 text-sm outline-none focus:ring-2 focus:ring-[#5d6b5b]">
                    <textarea v-model="newItem.notes" placeholder="備註..." rows="3" class="w-full bg-[#f4f3ef] border-none rounded-2xl p-4 text-sm outline-none resize-none focus:ring-2 focus:ring-[#5d6b5b]"></textarea>
                </div>
                <div v-if="currentTab === 'money'" class="space-y-5">
                    <div class="flex bg-[#f4f3ef] p-1 rounded-xl">
                        <button class="flex-1 py-3 rounded-xl text-sm transition-all flex items-center justify-center gap-2 font-bold" :class="newExpense.method === 'cash' ? 'pay-btn-active' : 'text-gray-400'" @click="newExpense.method = 'cash'"><i class="fa-solid fa-coins"></i> 現金</button>
                        <button class="flex-1 py-3 rounded-xl text-sm transition-all flex items-center justify-center gap-2 font-bold" :class="newExpense.method === 'card' ? 'pay-btn-active' : 'text-gray-400'" @click="newExpense.method = 'card'"><i class="fa-regular fa-credit-card"></i> 刷卡</button>
                    </div>
                    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                        <button v-for="cat in categories" :key="cat.val" @click="newExpense.category = cat.val" :class="['flex-shrink-0 px-4 py-2.5 rounded-xl border text-sm font-bold flex items-center gap-2 transition-all', newExpense.category === cat.val ? 'cat-btn-active' : 'border-gray-100 text-gray-400 bg-white']"><i :class="cat.icon"></i> {{ cat.label }}</button>
                    </div>
                    <input type="text" v-model="newExpense.item" placeholder="品項名稱" class="w-full bg-[#f4f3ef] border-none rounded-2xl p-4 text-sm font-bold outline-none focus:ring-2 focus:ring-[#5d6b5b]">
                    <div class="bg-[#f4f3ef] rounded-2xl p-4 flex items-center justify-between focus-within:ring-2 focus-within:ring-[#5d6b5b]">
                        <span class="text-gray-400 text-xs font-bold mr-2">JPY</span>
                        <input type="number" inputmode="numeric" pattern="[0-9]*" v-model="newExpense.amount" placeholder="0" class="bg-transparent text-right font-mono text-3xl font-bold text-[#5d6b5b] outline-none w-full">
                    </div>
                     <p class="text-right text-xs text-gray-400 font-bold font-mono mt-1">(匯率鎖定 {{ exchangeRate.toFixed(3) }}) ≈ NT$ {{ newExpense.amount ? formatNumber(Math.round(newExpense.amount * exchangeRate)) : 0 }}</p>
                </div>
                <div class="mt-8 flex gap-3">
                    <button @click="showModal = false" class="flex-1 py-4 rounded-2xl bg-gray-100 text-gray-500 text-sm font-bold hover:bg-gray-200">取消</button>
                    <button @click="saveItem" class="flex-1 py-4 rounded-2xl bg-[#5d6b5b] text-white text-sm font-bold shadow-xl shadow-[#5d6b5b]/30 active:scale-95 transition-transform">儲存</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    const firebaseConfig = {
      apiKey: "AIzaSyAkDj8Tl5ypr-F8_JqRhXiLoV1G_K_WrpI",
      authDomain: "kobe-trip-2026.firebaseapp.com",
      databaseURL: "https://kobe-trip-2026-default-rtdb.firebaseio.com",
      projectId: "kobe-trip-2026",
      storageBucket: "kobe-trip-2026.firebasestorage.app",
      messagingSenderId: "1035659944836",
      appId: "1:1035659944836:web:2191d0dad3432be79bb3d1",
      measurementId: "G-9F480MKXY2"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    createApp({
        setup() {
            const currentTab = ref('checklist'); 
            const showModal = ref(false); 
            const editingId = ref(null);
            const isLoading = ref(true);
            const showSkipButton = ref(false);
            const editingCheckItemId = ref(null);
            const editingCheckItemText = ref('');

            const dates = [ { key: '2026-03-05', label: '3/5 (四)' }, { key: '2026-03-06', label: '3/6 (五)' }, { key: '2026-03-07', label: '3/7 (六)' }, { key: '2026-03-08', label: '3/8 (日)' } ];
            const selectedDate = ref('2026-03-05'); 
            const exchangeRate = ref(0.22); 
            const newCheckItem = ref(''); 
            const cashBudget = ref(0); 
            const currentFlightStatus = ref('更新中...');
            
            const categories = [ { val: 'food', label: '餐飲', icon: 'fa-solid fa-utensils' }, { val: 'transport', label: '交通', icon: 'fa-solid fa-train-subway' }, { val: 'shopping', label: '購物', icon: 'fa-solid fa-bag-shopping' }, { val: 'ticket', label: '門票', icon: 'fa-solid fa-ticket' }, { val: 'hotel', label: '住宿', icon: 'fa-solid fa-bed' }, { val: 'other', label: '其他', icon: 'fa-solid fa-ellipsis' } ];
            
            const flightData = {
                '2026-03-05': { 
                    number: 'JX834', airline: 'STARLUX', colorClass: 'bg-[#b86e6e]', colorCode: '#b86e6e',
                    depCode: 'TPE', depTime: '07:00', arrCode: 'UKB', arrTime: '10:30', 
                    duration: '2h 30m', date: 'Mar 05', link: 'https://www.google.com/search?q=JX834+status' 
                },
                '2026-03-08': { 
                    number: 'JX835', airline: 'STARLUX', colorClass: 'bg-[#b86e6e]', colorCode: '#b86e6e',
                    depCode: 'UKB', depTime: '11:30', arrCode: 'TPE', arrTime: '13:50', 
                    duration: '3h 20m', date: 'Mar 08', link: 'https://www.google.com/search?q=JX835+status' 
                }
            };

            const itinerary = ref([]); const expenses = ref([]); const checklistItems = ref([]); const weatherData = ref({});
            const newItem = ref({ dateKey: '2026-03-05', time: '10:00', title: '', location: '', notes: '' });
            const newExpense = ref({ item: '', amount: '', category: 'food', method: 'cash', date: new Date().toISOString().split('T')[0] });

            let map = null; let markers = [];
            const initMap = () => { if(map) return; map = L.map('map', { zoomControl: false }).setView([34.6946, 135.1955], 13); L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '© CARTO', subdomains: 'abcd', maxZoom: 20 }).addTo(map); L.control.zoom({ position: 'bottomright' }).addTo(map); updateMapMarkers(); };
            const updateMapMarkers = async () => { if(!map) return; markers.forEach(m => map.removeLayer(m)); markers = []; const items = itinerary.value.filter(i => i.dateKey === selectedDate.value); const locationDb = { "Kobe Airport": [34.6328, 135.2239], "remm plus Kobe Sannomiya": [34.6946, 135.1955], "Nunobiki Herb Gardens": [34.7163, 135.1910], "Grill Ippei": [34.7045, 135.1940], "Kobe Anpanman Museum": [34.6806, 135.1873], "Mosaic": [34.6795, 135.1860], "Kawasaki World": [34.6822, 135.1887], "Meriken Park": [34.6826, 135.1867], "Nankinmachi": [34.6882, 135.1880], "Familiar Kobe": [34.6870, 135.1890], "Daimaru Kobe": [34.6885, 135.1895], "Tonkatsu KYK": [34.6925, 135.1945], "Torimitsu": [34.6930, 135.1950] }; const bounds = L.latLngBounds(); items.forEach((item, index) => { let latlon = null; for (const [key, val] of Object.entries(locationDb)) { if ((item.location && item.location.includes(key)) || (item.title && item.title.includes(key))) latlon = val; } if(latlon) { const iconHtml = `<div style="background:#5d6b5b; color:white; width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:bold; border:2px solid white; box-shadow:0 2px 5px rgba(0,0,0,0.3);">${index + 1}</div>`; const customIcon = L.divIcon({ html: iconHtml, className: 'custom-pin', iconSize: [24, 24] }); const marker = L.marker(latlon, { icon: customIcon }).addTo(map).bindPopup(item.title); markers.push(marker); bounds.extend(latlon); } }); if(items.length > 0 && markers.length > 0) map.fitBounds(bounds, { padding: [50, 50] }); };

            const switchTab = (tab) => { currentTab.value = tab; if(tab === 'map') nextTick(() => { initMap(); updateMapMarkers(); }); };
            const openAddModal = () => { editingId.value = null; newItem.value = { dateKey: selectedDate.value, time: '10:00', title: '', location: '', notes: '' }; newExpense.value = { item: '', amount: '', category: 'food', method: 'cash', date: new Date().toISOString().split('T')[0] }; showModal.value = true; };
            const editItinerary = (item) => { editingId.value = item.id; newItem.value = { ...item }; showModal.value = true; };
            
            const syncToCloud = () => {
                firebase.database().ref('kobeTripData').set({
                    itinerary: itinerary.value,
                    expenses: expenses.value,
                    checklistItems: checklistItems.value,
                    cashBudget: cashBudget.value
                });
            };

            const addCheckItem = () => { if(!newCheckItem.value.trim()) return; checklistItems.value.push({ id: Date.now(), text: newCheckItem.value, checked: false }); newCheckItem.value = ''; syncToCloud(); };
            const deleteCheckItem = (id) => { checklistItems.value = checklistItems.value.filter(i => i.id !== id); syncToCloud(); };
            
            const editCheckItem = (item) => {
                editingCheckItemId.value = item.id;
                editingCheckItemText.value = item.text;
                nextTick(() => { const el = document.getElementById('check-input-' + item.id); if(el) el.focus(); });
            };

            const saveCheckItem = () => {
                if (editingCheckItemId.value === null) return;
                const item = checklistItems.value.find(i => i.id === editingCheckItemId.value);
                if (item && editingCheckItemText.value.trim()) {
                    item.text = editingCheckItemText.value.trim();
                    syncToCloud();
                }
                editingCheckItemId.value = null;
                editingCheckItemText.value = '';
            };

            const fetchRate = async () => { try { const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY'); const data = await res.json(); exchangeRate.value = data.rates.TWD; } catch(e) {} };
            const fetchWeather = async () => { try { const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=34.6901&longitude=135.1955&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo&start_date=2026-03-05&end_date=2026-03-08'); const data = await res.json(); if(data.daily) { data.daily.time.forEach((t, i) => { weatherData.value[t] = { code: data.daily.weathercode[i], max: Math.round(data.daily.temperature_2m_max[i]), min: Math.round(data.daily.temperature_2m_min[i]) }; }); return; } } catch(e) {} };
            
            const formatNumber = (n) => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); const formatDate = (d) => d.substring(5).replace('-', '/'); const getDayLabel = (k) => dates.find(d => d.key === k)?.label;
            const getWeatherIcon = (c) => { if(c <= 1) return 'fa-solid fa-sun text-yellow-300'; if(c <= 3) return 'fa-solid fa-cloud-sun text-white'; if(c >= 51) return 'fa-solid fa-umbrella text-blue-200'; return 'fa-solid fa-cloud text-gray-300'; };
            const getCategoryIcon = (val) => categories.find(c => c.val === val)?.icon || 'fa-solid fa-circle-question';

            const currentDateItinerary = computed(() => itinerary.value.filter(i => i.dateKey === selectedDate.value).sort((a,b) => a.time.localeCompare(b.time)));
            const currentWeather = computed(() => weatherData.value[selectedDate.value]);
            const currentFlight = computed(() => flightData[selectedDate.value]);
            const totalExpense = computed(() => expenses.value.reduce((a,b) => a + Number(b.amount), 0));
            const totalTWD = computed(() => expenses.value.reduce((acc, exp) => acc + (Number(exp.amount) * (exp.fixedRate || exchangeRate.value)), 0));
            const remainingCash = computed(() => cashBudget.value - expenses.value.filter(e => e.method === 'cash').reduce((acc, e) => acc + Number(e.amount), 0));
            const groupedExpenses = computed(() => { const groups = {}; [...expenses.value].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(exp => { if(!groups[exp.date]) { const dateObj = dates.find(d => d.key === exp.date); groups[exp.date] = { date: exp.date, label: dateObj ? dateObj.label : exp.date, items: [], subtotal: 0 }; } groups[exp.date].items.push(exp); groups[exp.date].subtotal += Number(exp.amount); }); return Object.values(groups); });

            watch(selectedDate, () => { if(flightData[selectedDate.value]) { currentFlightStatus.value = '更新中...'; setTimeout(() => { currentFlightStatus.value = selectedDate.value === '2026-03-05' ? '準點 On Time' : '計劃中 Scheduled'; }, 800); } newItem.value.dateKey = selectedDate.value; if(currentTab.value === 'map') updateMapMarkers(); });

            function saveItem() { if(currentTab.value === 'money') { if(!newExpense.value.item) return; expenses.value.unshift({ id: Date.now(), ...newExpense.value, fixedRate: exchangeRate.value }); newExpense.value = { item: '', amount: '', category: newExpense.value.category, method: newExpense.value.method, date: new Date().toISOString().split('T')[0] }; } else { if(!newItem.value.title) return; if(editingId.value) { const idx = itinerary.value.findIndex(i => i.id === editingId.value); if(idx !== -1) itinerary.value[idx] = { ...newItem.value, id: editingId.value }; } else { itinerary.value.push({ id: Date.now(), ...newItem.value }); } newItem.value = { dateKey: selectedDate.value, time: '10:00', title: '', location: '', notes: '' }; editingId.value = null; } syncToCloud(); showModal.value = false; if(currentTab.value === 'map') updateMapMarkers(); }
            function deleteItinerary(id) { if(confirm('確定要刪除？')) { itinerary.value = itinerary.value.filter(i => i.id !== id); syncToCloud(); } }
            function deleteExpense(id) { expenses.value = expenses.value.filter(i => i.id !== id); syncToCloud(); }
            
            // 強制進入 (離線模式)
            function forceEnter() {
                isLoading.value = false;
                alert('已切換至離線模式。資料可能不會同步。');
            }

            // Initialize
            onMounted(() => {
                // 超時機制
                setTimeout(() => { if(isLoading.value) showSkipButton.value = true; }, 5000);

                const dataRef = firebase.database().ref('kobeTripData');
                dataRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        itinerary.value = data.itinerary || [];
                        expenses.value = data.expenses || [];
                        checklistItems.value = data.checklistItems || [];
                        cashBudget.value = data.cashBudget || 0;
                    } else {
                        // Default Data
                        checklistItems.value = [ { id: 1, text: "護照 & VJW QR Code", checked: false }, { id: 2, text: "網卡開通", checked: false }, { id: 3, text: "女兒備用藥 & 耳溫槍", checked: false } ];
                        itinerary.value = [ { id: 101, dateKey: '2026-03-05', time: '11:40', title: '飯店寄放行李', location: 'remm plus Kobe Sannomiya', notes: '' }, { id: 102, dateKey: '2026-03-05', time: '12:00', title: '午餐：Tonkatsu KYK', location: 'Santica Sannomiya', notes: '' }, { id: 103, dateKey: '2026-03-05', time: '14:00', title: '布引香草園', location: 'Nunobiki Herb Gardens', notes: '' }, { id: 104, dateKey: '2026-03-05', time: '17:00', title: '下山回三宮', location: 'Sannomiya', notes: '' }, { id: 105, dateKey: '2026-03-05', time: '17:30', title: '晚餐：Torimitsu 鳥光', location: 'Santica Sannomiya', notes: '' }, { id: 201, dateKey: '2026-03-06', time: '10:00', title: '麵包超人博物館', location: 'Kobe Anpanman Museum', notes: '' }, { id: 202, dateKey: '2026-03-06', time: '12:30', title: '午餐：Mosaic 自助餐', location: 'Mosaic Kobe', notes: '' }, { id: 203, dateKey: '2026-03-06', time: '15:00', title: '川崎重工世界', location: 'Kawasaki World', notes: '' }, { id: 204, dateKey: '2026-03-06', time: '18:00', title: '晚餐：南京町', location: 'Nankinmachi', notes: '' }, { id: 301, dateKey: '2026-03-07', time: '11:00', title: '神戶港遊覽船', location: 'Kobe Port Tower', notes: '' }, { id: 302, dateKey: '2026-03-07', time: '15:00', title: 'Familiar 本店', location: 'Familiar Kobe', notes: '' }, { id: 401, dateKey: '2026-03-08', time: '09:50', title: '機場展望台', location: 'Kobe Airport', notes: '' } ];
                        cashBudget.value = 100000;
                        syncToCloud();
                    }
                    isLoading.value = false;
                });
                fetchWeather(); fetchRate();
            });

            return { currentTab, showModal, dates, selectedDate, exchangeRate, itinerary, expenses, newItem, newExpense, weatherData, checklistItems, newCheckItem, editingId, categories, currentDateItinerary, totalExpense, currentWeather, totalTWD, cashBudget, remainingCash, groupedExpenses, currentFlight, currentFlightStatus, saveItem, deleteItinerary, deleteExpense, switchTab, addCheckItem, deleteCheckItem, openAddModal, editItinerary, formatNumber, formatDate, getWeatherIcon, getDayLabel, fetchRate, getCategoryIcon, isLoading, showSkipButton, forceEnter, syncToCloud, editingCheckItemId, editingCheckItemText, editCheckItem, saveCheckItem };
        }
    }).mount('#app');
</script>
</body>
</html>
